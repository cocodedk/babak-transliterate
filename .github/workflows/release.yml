name: Create Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version
        id: bump
        run: |
          node - <<'NODE'
          const fs = require('fs');

          const manifestPath = 'src/manifest.json';
          const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
          const parts = manifest.version.split('.').map(Number);
          if (parts.length !== 3 || parts.some(Number.isNaN)) {
            throw new Error(`Invalid manifest version: ${manifest.version}`);
          }
          parts[2] += 1;
          const newVersion = parts.join('.');
          manifest.version = newVersion;
          fs.writeFileSync(manifestPath, JSON.stringify(manifest, null, 2) + '\n');

          const htmlPath = 'docs/index.html';
          let html = fs.readFileSync(htmlPath, 'utf8');
          html = html.replace(/(<span class="meta-value">)\d+\.\d+\.\d+(<\/span>)/, `$1${newVersion}$2`);
          html = html.replace(/("softwareVersion"\s*:\s*")\d+\.\d+\.\d+(")/, `$1${newVersion}$2`);
          fs.writeFileSync(htmlPath, html);

          fs.appendFileSync(process.env.GITHUB_OUTPUT, `version=${newVersion}\n`);
          NODE

      - name: Commit version bump
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add src/manifest.json docs/index.html
          git commit -m "chore: bump version to v${{ steps.bump.outputs.version }}"
          git push
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Package extension
        run: zip -r ai-transliterator-extension.zip src

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump.outputs.version }}
          name: v${{ steps.bump.outputs.version }}
          target_commitish: ${{ steps.commit.outputs.sha }}
          generate_release_notes: true
          files: ai-transliterator-extension.zip
